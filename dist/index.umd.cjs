(function(r,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("lodash")):typeof define=="function"&&define.amd?define(["exports","lodash"],n):(r=typeof globalThis<"u"?globalThis:r||self,n(r["html-form-validator"]={},r.lodash))})(this,function(r,n){"use strict";var C=Object.defineProperty;var P=(r,n,d)=>n in r?C(r,n,{enumerable:!0,configurable:!0,writable:!0,value:d}):r[n]=d;var l=(r,n,d)=>(P(r,typeof n!="symbol"?n+"":n,d),d);class d extends Promise{constructor(t){const a=new AbortController;a.signal.throwIfAborted();super((s,i)=>{t(s,i,a.signal)});l(this,"abortController");this.abortController=a}cancel(){this.abortController.abort()}}const v=o=>o!==void 0?["","true","1"].includes(o):!1,b=o=>new Promise(e=>setTimeout(e,o)),p=(o,e,t)=>{new MutationObserver(a=>t(a[a.length-1])).observe(o,{attributes:!0,attributeFilter:[...e]})};class x{constructor(e){l(this,"elmt");l(this,"errorsListElmt");l(this,"valid");l(this,"errors",[]);l(this,"invalidators",[]);l(this,"matchTo");l(this,"matchOf");l(this,"valueEventHandler",null);this.elmt=e,this.valid=!1,this.matchTo=null,this.matchOf=[],this.errorsListElmt=document.querySelector(`[data-fv-errors="${e.name}"]`),this.addInvalidator((t,a)=>{this.matchTo!==null&&(t!==this.matchTo.elmt.value||t===""&&v(this.matchTo.elmt.dataset.fvRequired))&&a(this.matchTo.elmt.dataset.fvDisplayName!==void 0?`${this.elmt.dataset.fvDisplayName??"This"} does not match ${this.matchTo.elmt.dataset.fvDisplayName}`:`${this.elmt.dataset.fvDisplayName??"This"} does not match`)})}async checkValidity(){this.elmt.dataset.fvCheckingValidity="true";try{await this.runInvalidationChecks().catch(()=>{})}catch{return}return this.elmt.dataset.fvCheckingValidity="false",Promise.all(this.matchOf.map(e=>e.checkValidity())),this.valid}async runInvalidationChecks(){var t;this.validate();const e=a=>this.invalidators.filter(s=>s.when===a).map(s=>(s.instance=s.check(this.elmt.value,this.invalidate.bind(this)),s.instance));for(const a of this.invalidators)(t=a.instance)==null||t.cancel();await Promise.all(e("before-other-checks")),this.valid&&(await Promise.all(e("with-other-checks")),this.valid&&await Promise.all(e("after-other-checks-passed")))}addInvalidator(e,t){const a={when:(t==null?void 0:t.when)??"with-other-checks",check(s,i){return new d((h,L,w)=>{(async()=>(t==null?void 0:t.debounce)!==void 0&&(await b(t.debounce),w.aborted)||(await e(s,T=>{w.aborted||i(T)}),h()))()})},instance:null};this.invalidators.push(a)}validate(){if(this.errors.splice(0,this.errors.length),this.errorsListElmt!==null)for(;this.errorsListElmt.lastChild!==null;)this.errorsListElmt.removeChild(this.errorsListElmt.lastChild);this.elmt.dataset.fvValid="true",this.valid=!0}invalidate(e){if(this.errors.push(e),this.errorsListElmt!==null){const t=document.createElement("li");t.textContent=e,this.errorsListElmt.appendChild(t)}this.elmt.dataset.fvValid="false",this.valid=!1}initDataset(){this.elmt.dataset.fvValid=`${this.valid}`,this.elmt.dataset.fvCheckingValidity="false"}validateOnChange(){this.valueEventHandler===null&&(this.valueEventHandler=()=>{this.checkValidity()},this.elmt.addEventListener("input",this.valueEventHandler),this.elmt.addEventListener("change",this.valueEventHandler))}stopValidatingOnChange(){this.valueEventHandler!==null&&(this.elmt.removeEventListener("input",this.valueEventHandler),this.elmt.removeEventListener("change",this.valueEventHandler))}}class g extends x{constructor(t){super(t);l(this,"elmt");this.elmt=t,this.addInvalidator((a,s)=>{this.elmt.dataset.fvRequired!==void 0&&this.matchTo===null&&v(this.elmt.dataset.fvRequired)&&a===""&&s(`${this.elmt.dataset.fvDisplayName??"This"} is required`)})}}class E extends g{constructor(t){super(t);l(this,"elmt");this.elmt=t,this.addInvalidator((a,s)=>{if(this.elmt.dataset.fvMinLength!==void 0){const i=parseInt(this.elmt.dataset.fvMinLength);if(isNaN(i))throw new Error(`Form control '${this.elmt.name}' has an invalid minimum length 'data-fv-min-length' value`);this.elmt.value.length<i&&s(`${this.elmt.dataset.fvDisplayName??"This"} must have more than ${i} characters`)}}),this.addInvalidator((a,s)=>{if(this.elmt.dataset.fvMaxLength!==void 0){const i=parseInt(this.elmt.dataset.fvMaxLength);if(isNaN(i))throw new Error(`Form control '${this.elmt.name}' has an invalid maximum length 'data-fv-max-length' value`);this.elmt.value.length>=i&&s(`${this.elmt.dataset.fvDisplayName??"This"} must have less than or equal to ${i} characters`)}})}}class y extends E{constructor(t){super(t);l(this,"elmt");this.elmt=t,this.addInvalidator((a,s)=>{if(this.elmt.dataset.fvMin!==void 0){const i=parseInt(this.elmt.dataset.fvMin);if(isNaN(i))throw new Error(`Form control '${this.elmt.name}' has an invalid minimum 'data-fv-min' value`);parseInt(this.elmt.value)<i&&s(`${this.elmt.dataset.fvDisplayName??"This"} must be greater than or equal to ${i}`)}}),this.addInvalidator((a,s)=>{if(this.elmt.dataset.fvMax!==void 0){const i=parseInt(this.elmt.dataset.fvMax);if(isNaN(i))throw new Error(`Form control '${this.elmt.name}' has an invalid maximum 'data-fv-max' value`);parseInt(this.elmt.value)>i&&s(`${this.elmt.dataset.fvDisplayName??"This"} must be less than or equal to ${i}`)}})}}class F extends x{constructor(t){super(t);l(this,"elmt");l(this,"associatedElmts");this.elmt=t,this.associatedElmts=Array.from(t.form.elements).filter(a=>a.type===t.type&&a.name===t.name),this.addInvalidator((a,s)=>{this.elmt.dataset.fvRequired!==void 0&&v(this.elmt.dataset.fvRequired)&&!this.associatedElmts.some(i=>i.checked)&&s(`${this.elmt.dataset.fvDisplayName??"This"} is required`)})}validate(){super.validate();for(const t of this.associatedElmts)t.dataset.fvValid="true"}invalidate(t){super.invalidate(t);for(const a of this.associatedElmts)a.dataset.fvValid="false"}validateOnChange(){if(super.validateOnChange(),this.valueEventHandler!==null)for(const t of this.associatedElmts)t.addEventListener("input",this.valueEventHandler),t.addEventListener("change",this.valueEventHandler)}stopValidatingOnChange(){if(super.stopValidatingOnChange(),this.valueEventHandler!==null)for(const t of this.associatedElmts)t.removeEventListener("input",this.valueEventHandler),t.removeEventListener("change",this.valueEventHandler)}}class $ extends g{constructor(t){super(t);l(this,"elmt");this.elmt=t}}const c=class c extends E{constructor(t,a){super(t);l(this,"elmt");l(this,"options");this.elmt=t,this.options=n.merge({},c.defaultOptions,a),this.addInvalidator((s,i)=>{const h=this.getPatternRegExp();h!==null&&this.elmt.dataset.fvPatternPreset!==void 0&&console.warn(`Form control '${this.elmt.name}' has both a custom pattern 'data-fv-pattern' and preset pattern 'data-fv-pattern-preset' set. The custom pattern is being ignored.`),this.elmt.dataset.fvPatternPreset!==void 0?(this.elmt.dataset.fvPatternPreset==="email"&&!this.options.patternPresets.email.test(s)&&i("This is not a valid email"),this.elmt.dataset.fvPatternPreset==="phone-number"&&!this.options.patternPresets.phoneNumber.test(s)&&i("This is not a valid phone number")):h!==null&&!h.test(s)&&i(`This is not a valid ${this.elmt.dataset.fvPatternLabel??"value"}`)})}getPatternRegExp(){const t=this.elmt.dataset.fvPattern;return t!==void 0?new RegExp(t):null}};l(c,"defaultOptions",{patternPresets:{email:/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/,phoneNumber:/^[\s+()\d]*$/}});let m=c;const f=class f{constructor(e,t){l(this,"fields",[]);l(this,"form");l(this,"options");this.form=e,this.options=n.merge({},f.defaultOptions,t),this.loadAllFields()}getField(e){return this.fields.find(t=>t.elmt.name===e)??null}async checkValidity(){return!(await Promise.all(this.fields.map(t=>t.checkValidity()))).some(t=>!t)}watchAllFields(){for(const e of this.fields)e.validateOnChange()}ignoreAllFields(){for(const e of this.fields)e.stopValidatingOnChange()}loadAllFields(){const e=Array.from(this.form.elements).filter(t=>t.dataset.fvValidate!==void 0);for(const t of e){if(this.fields.some(s=>s.elmt===t)||t.name!==""&&this.fields.some(s=>s.elmt.name===t.name))continue;const a=this.createField(t);this.addField(a)}for(const t of this.fields.filter(a=>!e.some(s=>a.elmt===s)))this.removeField(t);this.setFieldsRelations()}createField(e){switch(e.type){case"text":case"tel":case"email":case"url":case"password":case"search":return new m(e,this.options);case"select-one":case"select-multiple":return new $(e);case"radio":case"checkbox":return new F(e);case"date":case"month":case"week":case"time":case"datetime-local":case"number":case"range":return new y(e);default:throw new Error(`Failed to create field using a form control of an unknown type '${e.type}'`)}}addField(e){this.fields.push(e)}removeField(e){this.fields.splice(this.fields.indexOf(e),1)}setFieldsRelations(){for(const e of this.fields)this.setFieldRelations(e)}setFieldRelations(e){if(e.elmt.dataset.fvMatch===void 0){e.matchTo=null;return}const t=this.fields.find(a=>e.elmt.dataset.fvMatch===a.elmt.name);if(t===void 0)throw new Error(`Failed to find form control '${e.elmt.dataset.fvMatch}' to match with '${e.elmt.name}'`);e.matchTo=t,t.matchOf.push(e),p(t.elmt,"name",()=>e.elmt.dataset.fvMatch=t.elmt.name),p(e.elmt,"data-fv-match",()=>{e.elmt.dataset.fvMatch!==t.elmt.name&&(t.matchOf.splice(t.matchOf.indexOf(e)),this.setFieldRelations(e))})}};l(f,"defaultOptions",n.merge({},m.defaultOptions));let u=f;r.FormValidator=u,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
